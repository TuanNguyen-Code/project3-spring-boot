<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Tủ sách cá nhân</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
        body { display: none; background-color: #f8f9fa; }
    </style>
</head>
<body>

<script>
        // Kiểm tra ngay lập tức
        const userId = localStorage.getItem('nmit_userId');
        const isLogged = localStorage.getItem('nmit_isLoggedIn');

        if (!userId || !isLogged) {
            // Chưa đăng nhập -> Đá về Login ngay lập tức
            window.location.href = '/nmitlogin';
        } else {
            // Đã đăng nhập -> Cho hiện giao diện lên
            document.body.style.display = 'block';
        }
    </script>

<nav class="navbar navbar-dark bg-danger mb-4 shadow">
  <div class="container">
    <a class="navbar-brand fw-bold" href="/"><i class="fas fa-book-reader"></i> E-LIBRARY</a>
    <div class="d-flex gap-2">
      <span class="text-white align-self-center">Xin chào, <b id="userName">...</b></span>
      <a href="/" class="btn btn-outline-light btn-sm">Về trang chủ</a>
    </div>
  </div>
</nav>

<div class="container">
  <div class="row justify-content-center">
    <div class="col-md-10">
      <div class="card shadow-sm border-0">
        <div class="card-header bg-white border-bottom-0 pt-4 pb-0">
          <h4 class="text-danger mb-0 fw-bold"><i class="fas fa-history"></i> TỦ SÁCH CỦA TÔI</h4>
          <p class="text-muted small mt-1">Danh sách sách bạn đang mượn và lịch sử trả</p>
        </div>
        <div class="card-body">
          <table class="table table-hover align-middle">
            <thead class="table-light">
            <tr>
              <th>Thông tin sách</th>
              <th>Ngày mượn</th>
              <th>Ngày trả</th>
              <th>Trạng thái</th>
              <th class="text-end">Hành động</th>
            </tr>
            </thead>
            <tbody id="historyTable">
            <tr><td colspan="5" class="text-center text-muted py-4">Đang tải dữ liệu...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
        // --- LOGIC TẢI DỮ LIỆU ---
        const API_URL = 'http://localhost:8080/api/nmit';

        // Hiển thị tên
        document.getElementById('userName').innerText = localStorage.getItem('nmit_user');

        async function loadMyBooks() {
            try {
                // Lấy ID từ localStorage (đã kiểm tra ở trên đầu trang rồi nên chắc chắn có)
                const uid = localStorage.getItem('nmit_userId');

                const res = await fetch(`${API_URL}/my-books?userId=${uid}`);
                const records = await res.json();
                let html = '';

                if (records.length === 0) {
                    html = '<tr><td colspan="5" class="text-center py-5 text-muted"><i class="fas fa-box-open fa-3x mb-3"></i><br>Bạn chưa mượn cuốn sách nào.</td></tr>';
                } else {
                    records.forEach(r => {
                        let statusBadge, actionBtn;

                        if (r.nmitStatus === 'BORROWING') {
                            statusBadge = '<span class="badge bg-warning text-dark border border-warning">Đang mượn</span>';
                            actionBtn = `<button class="btn btn-sm btn-outline-primary fw-bold" onclick="returnBook(${r.nmitRecordId})">
                                            <i class="fas fa-undo"></i> Trả sách
                                         </button>`;
                        } else {
                            statusBadge = '<span class="badge bg-success border border-success">Đã trả</span>';
                            actionBtn = '<span class="text-success small fw-bold"><i class="fas fa-check-circle"></i> Hoàn tất</span>';
                        }

                        html += `
                            <tr>
                                <td>
                                    <div class="fw-bold text-dark">${r.nmitBook.nmitTitle}</div>
                                    <small class="text-muted"><i class="fas fa-pen"></i> ${r.nmitBook.nmitAuthor}</small>
                                </td>
                                <td>${r.nmitBorrowDate}</td>
                                <td>${r.nmitReturnDate || '--'}</td>
                                <td>${statusBadge}</td>
                                <td class="text-end">${actionBtn}</td>
                            </tr>
                        `;
                    });
                }
                document.getElementById('historyTable').innerHTML = html;
            } catch (e) {
                console.error(e);
                document.getElementById('historyTable').innerHTML = '<tr><td colspan="5" class="text-center text-danger">Lỗi kết nối server!</td></tr>';
            }
        }

        async function returnBook(recordId) {
            if(!confirm("Xác nhận trả cuốn sách này?")) return;
            try {
                const res = await fetch(`${API_URL}/return/${recordId}`, { method: 'POST' });
                if (res.ok) {
                    alert("Đã trả sách thành công!");
                    loadMyBooks();
                } else {
                    alert("Lỗi khi trả sách!");
                }
            } catch (e) { alert("Lỗi kết nối!"); }
        }

        loadMyBooks();
    </script>
</body>
</html>