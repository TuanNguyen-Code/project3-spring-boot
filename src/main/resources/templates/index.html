<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Library | Trang ch·ªß</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #f4f4f4; }
        .cps-header { background-color: #d70018; color: white; padding: 10px 0; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }

        /* Search Bar Style */
        .search-bar { position: relative; }
        .search-bar input { border-radius: 10px; border: none; padding-left: 35px; }
        .search-bar i { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: #777; }

        /* Banner Styles */
        .banner-section { margin-top: 20px; margin-bottom: 20px; }
        .banner-img { width: 100%; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); object-fit: cover; }
        .main-banner { height: 300px; }
        .side-banner { height: 145px; margin-bottom: 10px; }

        /* Card Styles */
        .book-card {
            background: white; border-radius: 10px; padding: 10px; transition: all 0.3s ease;
            height: 100%; display: flex; flex-direction: column; justify-content: space-between;
            box-shadow: 0 1px 2px 0 rgba(60,64,67,.1), 0 2px 6px 2px rgba(60,64,67,.15);
            position: relative;
        }
        .book-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .book-img { width: 100%; height: 200px; object-fit: cover; border-radius: 8px; margin-bottom: 10px; }
        .book-title { font-size: 14px; font-weight: 700; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; margin-bottom: 5px; color: #444; }
        .book-price { color: #d70018; font-weight: bold; font-size: 16px; margin-bottom: 5px; }
        .btn-cps { background-color: white; color: #d70018; border: 1px solid #d70018; width: 100%; font-weight: 500; border-radius: 8px; padding: 6px; transition: 0.2s; }
        .btn-cps:hover { background-color: #d70018; color: white; }

        .section-title { font-weight: 700; margin-bottom: 15px; text-transform: uppercase; font-size: 18px; border-left: 4px solid #d70018; padding-left: 10px; }
        .top-read-container { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
    </style>
</head>
<body>

<header class="cps-header sticky-top">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-3">
                <a href="/" class="text-white text-decoration-none d-flex align-items-center gap-2">
                    <i class="fas fa-book-open fa-2x"></i>
                    <span class="h4 mb-0 fw-bold">E-LIBRARY</span>
                </a>
            </div>

            <div class="col-md-5">
                <div class="search-bar">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" class="form-control" placeholder="B·∫°n c·∫ßn t√¨m s√°ch g√¨ h√¥m nay?">
                </div>
            </div>

            <div class="col-md-4 text-end">
                <div id="guest-view">
                    <a href="/nmitlogin" class="btn btn-sm btn-light text-danger fw-bold shadow-sm">
                        <i class="fas fa-user-circle"></i> ƒêƒÉng nh·∫≠p
                    </a>
                </div>

                <div id="user-view" style="display: none;" class="d-flex align-items-center justify-content-end gap-2">
                    <span class="text-white small">Xin ch√†o, <b id="display-username">Kh√°ch qua ch∆°i</b></span>

                    <a href="/nmitprofile" class="btn btn-sm btn-outline-light rounded-pill">
                        <i class="fas fa-book"></i> T·ªß s√°ch c·ªßa t√¥i
                    </a>

                    <a href="/nmitadmin" id="btn-admin-page" class="btn btn-sm btn-outline-light rounded-pill" style="display: none;">
                        <i class="fas fa-cogs"></i> Qu·∫£n tr·ªã
                    </a>

                    <button onclick="logout()" class="btn btn-sm btn-light text-dark" title="ƒêƒÉng xu·∫•t">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</header>

<div class="container banner-section">
    <div class="row">
        <div class="col-md-8 mb-2">
            <img id="banner-main" src="https://placehold.co/800x300/eee/999?text=Loading..." class="banner-img main-banner" alt="Banner Ch√≠nh">
        </div>
        <div class="col-md-4">
            <img id="banner-side-1" src="https://placehold.co/400x145/eee/999?text=Loading..." class="banner-img side-banner" alt="Banner Ph·ª• 1">
            <img id="banner-side-2" src="https://placehold.co/400x145/eee/999?text=Loading..." class="banner-img side-banner" style="margin-bottom: 0;" alt="Banner Top">
        </div>
    </div>
</div>

<div class="container top-read-container shadow-sm">
    <h2 class="section-title text-danger">üî• TOP S√ÅCH ƒê·ªåC NHI·ªÄU</h2>
    <div class="row row-cols-2 row-cols-md-5 g-3" id="topReadGrid">
        <div class="text-center w-100">ƒêang t·∫£i...</div>
    </div>
</div>

<div class="container pb-5">
    <h3 class="section-title">KHO S√ÅCH HI·ªÜN C√ì</h3>
    <div class="row row-cols-2 row-cols-sm-3 row-cols-md-4 row-cols-lg-5 g-3" id="bookGrid"></div>
</div>

<script>
        const API_BASE = 'http://localhost:8080/api/nmit';

        // --- 1. X·ª¨ L√ù AUTHENTICATION (ƒêƒÉng nh·∫≠p/ƒêƒÉng xu·∫•t) ---
        function checkLoginState() {
            const isLogged = localStorage.getItem('nmit_isLoggedIn');
            const fullName = localStorage.getItem('nmit_user');
            const role = localStorage.getItem('nmit_role');

            const guestView = document.getElementById('guest-view');
            const userView = document.getElementById('user-view');
            const btnAdmin = document.getElementById('btn-admin-page');
            const txtName = document.getElementById('display-username');

            if (isLogged === 'true') {
                // ƒê√£ ƒëƒÉng nh·∫≠p
                guestView.style.display = 'none';
                userView.style.display = 'flex';
                txtName.innerText = fullName;

                // N·∫øu l√† Admin th√¨ hi·ªán n√∫t Qu·∫£n tr·ªã, User th∆∞·ªùng th√¨ ·∫©n
                if (role === 'ADMIN') {
                    btnAdmin.style.display = 'inline-block';
                } else {
                    btnAdmin.style.display = 'none';
                }
            } else {
                // Ch∆∞a ƒëƒÉng nh·∫≠p
                guestView.style.display = 'block';
                userView.style.display = 'none';
            }
        }

        function logout() {
            if(confirm("B·∫°n mu·ªën ƒëƒÉng xu·∫•t?")) {
                localStorage.removeItem('nmit_isLoggedIn');
                localStorage.removeItem('nmit_role');
                localStorage.removeItem('nmit_user');
                window.location.reload(); // T·∫£i l·∫°i trang ƒë·ªÉ reset giao di·ªán
            }
        }

        // --- 2. H√ÄM API
        async function loadBanners() {
            const positions = [
                { code: 'MAIN', elementId: 'banner-main' },
                { code: 'SIDE_TOP', elementId: 'banner-side-1' },
                { code: 'SIDE_BOTTOM', elementId: 'banner-side-2' }
            ];
            for (const pos of positions) {
                try {
                    const res = await fetch(`${API_BASE}/banners?position=${pos.code}`);
                    const banners = await res.json();
                    if (banners.length > 0) document.getElementById(pos.elementId).src = banners[0].nmitImageUrl;
                } catch (e) {}
            }
        }

        async function loadTopReadBooks() {
            try {
                const res = await fetch(`${API_BASE}/top-read`);
                const books = await res.json();
                const grid = document.getElementById('topReadGrid');
                grid.innerHTML = '';
                books.forEach(book => grid.innerHTML += createBookCard(book, true));
            } catch (e) {}
        }

        async function loadAllBooks(keyword = '') {
            let url = API_BASE;
            if(keyword) url += `?keyword=${keyword}`;
            try {
                const res = await fetch(url);
                const books = await res.json();
                const grid = document.getElementById('bookGrid');
                grid.innerHTML = '';
                if(books.length === 0) grid.innerHTML = '<div class="col-12 text-center py-5">Kh√¥ng t√¨m th·∫•y s√°ch!</div>';
                books.forEach(book => grid.innerHTML += createBookCard(book, false));
            } catch (e) {}
        }

        function createBookCard(book, isTop) {
            let statusBadge = book.nmitAvailable > 0
                ? `<span class="badge bg-success" style="font-size: 10px;">C√≤n ${book.nmitAvailable}</span>`
                : `<span class="badge bg-secondary" style="font-size: 10px;">H·∫øt h√†ng</span>`;

            let btnDisabled = book.nmitAvailable > 0 ? '' : 'disabled';
            let btnText = book.nmitAvailable > 0 ? 'M∆Ø·ª¢N NGAY' : 'ƒêƒÇNG K√ù';
            let hotBadge = isTop ? `<span class="badge bg-warning text-dark position-absolute top-0 start-0 m-2 shadow-sm">TOP 1</span>` : '';
            const imgUrl = `https://placehold.co/200x200/5F9EA0/white?text=${book.nmitTitle.substring(0,10)}...`;

// T·∫†O LINK CHI TI·∫æT
            const detailLink = `/product-detail?id=${book.nmitId}`;

            return `
                <div class="col">
                    <div class="book-card">
                        ${hotBadge}
                        <a href="${detailLink}">
                            <img src="${imgUrl}" class="book-img" alt="${book.nmitTitle}">
                        </a>
                        <div>
                            <a href="${detailLink}" class="text-decoration-none text-dark">
                                <div class="book-title" title="${book.nmitTitle}">${book.nmitTitle}</div>
                            </a>
                            <div class="book-price">
                                ${book.nmitAvailable}/${book.nmitQuantity} <small class="text-muted fw-normal">kho</small>
                            </div>
                            <div class="mb-2 text-muted" style="font-size: 12px;">
                                <i class="fas fa-pen-nib"></i> ${book.nmitAuthor}
                            </div>
                        </div>
                        <button class="btn btn-cps mt-2" onclick="borrowBook(${book.nmitId})" ${btnDisabled}>${btnText}</button>
                    </div>
                </div>
            `;
        }

        // H√†m m∆∞·ª£n s√°ch
        async function borrowBook(id) {
            // 1. KI·ªÇM TRA B·∫¢O M·∫¨T (Frontend)
            // L·∫•y ID v√† tr·∫°ng th√°i ƒëƒÉng nh·∫≠p t·ª´ b·ªô nh·ªõ tr√¨nh duy·ªát
            const userId = localStorage.getItem('nmit_userId');
            const isLogged = localStorage.getItem('nmit_isLoggedIn');

            // N·∫øu thi·∫øu 1 trong 2 -> Nghƒ©a l√† ch∆∞a ƒëƒÉng nh·∫≠p h·ª£p l·ªá
            if (!userId || !isLogged) {
                alert("B·∫°n ph·∫£i ƒëƒÉng nh·∫≠p m·ªõi ƒë∆∞·ª£c m∆∞·ª£n s√°ch!");
                window.location.href = '/nmitlogin'; // Chuy·ªÉn h∆∞·ªõng ngay
                return; // D·ª´ng h√†m, kh√¥ng cho ch·∫°y code b√™n d∆∞·ªõi
            }

            // 2. X√ÅC NH·∫¨N NG∆Ø·ªúI D√ôNG
            if(!confirm("X√°c nh·∫≠n m∆∞·ª£n cu·ªën s√°ch n√†y?")) return;

            // 3. G·ªåI API (G·ª≠i k√®m userId th·∫≠t)
            try {
                const res = await fetch(`${API_BASE}/${id}/borrow-user?userId=${userId}`, { method: 'POST' });

                if (res.ok) {
                    alert("M∆∞·ª£n th√†nh c√¥ng! Vui l√≤ng v√†o 'T·ªß s√°ch c·ªßa t√¥i' ƒë·ªÉ ki·ªÉm tra.");
                    loadTopReadBooks();
                    loadAllBooks();
                } else {
                    const msg = await res.text();
                    alert("L·ªói: " + msg);
                }
            } catch (e) { alert("L·ªói k·∫øt n·ªëi server!"); }
        }
        document.getElementById('searchInput').addEventListener('keyup', (e) => loadAllBooks(e.target.value));

        // CH·∫†Y KHI LOAD TRANG
        checkLoginState(); // <--- Ki·ªÉm tra ƒëƒÉng nh·∫≠p ngay l·∫≠p t·ª©c
        loadBanners();
        loadTopReadBooks();
        loadAllBooks();
    </script>
</body>
</html>